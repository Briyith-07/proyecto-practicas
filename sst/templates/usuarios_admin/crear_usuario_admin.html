{% extends 'base.html' %}
{% block title %}Crear Usuario{% endblock %}

{% block content %}
<style>
  .valid {
    color: rgba(3, 181, 3, 0.662);
    font-weight: bold;
  }
  .invalid {
    color: rgba(131, 127, 127, 0.537);
    font-weight: bold;
  }
</style>

<div class="container mt-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-3">Registrar Usuario</h2>

    {% if form.errors %}
      <div class="alert alert-danger">
        <ul class="mb-0">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="row">
        <div class="col-md-6 mb-3">
          {{ form.first_name.label_tag }}
          {{ form.first_name }}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.last_name.label_tag }}
          {{ form.last_name }}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.cedula.label_tag }}
          {{ form.cedula }}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.telefono.label_tag }}
          {{ form.telefono }}
        </div>

        <!-- Departamento -->
        <div class="col-md-6 mb-3">
          {{ form.departamento.label_tag }}
          <select id="id_departamento" name="departamento" class="form-control">
            <option value="">Seleccione un departamento</option>
            <option value="Cundinamarca">Cundinamarca</option>
            <option value="Antioquia">Antioquia</option>
            <option value="Valle del Cauca">Valle del Cauca</option>
            <option value="Bogot√°">Bogot√°</option>
          </select>
        </div>

        <!-- Ciudad -->
        <div class="col-md-6 mb-3">
          {{ form.ciudad.label_tag }}
          <select id="id_ciudad" name="ciudad" class="form-control">
            <option value="">Seleccione una ciudad</option>
          </select>
        </div>

        <div class="col-md-6 mb-3">
          {{ form.direccion.label_tag }}
          {{ form.direccion }}
        </div>

        <div class="col-md-6 mb-3">
          {{ form.email.label_tag }}
          {{ form.email }}
        </div>

          <div class="col-md-6 mb-3">
      {{ form.rol.label_tag }}
      {{ form.rol }}
      {% if form.rol.errors %}
        <div class="text-danger mt-1">{{ form.rol.errors }}</div>
      {% endif %}
    </div>

        <div class="col-md-6 mb-3">
          {{ form.password1.label_tag }}
          <div class="input-group">
            {{ form.password1 }}
            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_password1')">üëÅ</button>
          </div>
          <ul id="password-requirements" class="mt-2 mb-0">
            <li id="lower-upper" class="invalid">‚úî Min√∫sculas y May√∫sculas</li>
            <li id="number" class="invalid">‚úî N√∫mero (0-9)</li>
            <li id="special" class="invalid">‚úî Car√°cter especial (^!@#$%&*)</li>
            <li id="length" class="invalid">‚úî Al menos 8 caracteres</li>
          </ul>
        </div>

        <div class="col-md-6 mb-3">
          {{ form.password2.label_tag }}
          <div class="input-group">
            {{ form.password2 }}
            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_password2')">üëÅ</button>
          </div>
          <small id="password-match-msg" class="form-text text-danger"></small>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary w-100">Registrarse</button>
      </div>

      <div class="text-center mt-4">
        <a href="/usuarios/" class="btn btn-secondary">Volver</a>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const departamentoSelect = document.getElementById('id_departamento');
    const ciudadSelect = document.getElementById('id_ciudad');

    const ciudadesPorDepartamento = {
      "Cundinamarca": ["Girardot", "Soacha", "Fusagasug√°", "Zipaquir√°", "Ricaurte"],
      "Antioquia": ["Medell√≠n", "Envigado", "Bello", "Itag√º√≠"],
      "Valle del Cauca": ["Cali", "Palmira", "Buenaventura", "Tulu√°"],
      "Bogot√°": ["Bogot√°"]
    };

    function actualizarCiudades() {
      const selectedDept = departamentoSelect.value;
      ciudadSelect.innerHTML = '<option value="">Seleccione una ciudad</option>';

      if (ciudadesPorDepartamento[selectedDept]) {
        ciudadesPorDepartamento[selectedDept].forEach(function (ciudad) {
          ciudadSelect.appendChild(new Option(ciudad, ciudad));
        });
      }
    }

    // inicializa por si ya hay valor seleccionado
    actualizarCiudades(); 
    departamentoSelect.addEventListener('change', actualizarCiudades);
  });

  function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  }

  const passwordInput = document.getElementById("id_password1");
  const passwordConfirm = document.getElementById("id_password2");
  const lowerUpper = document.getElementById("lower-upper");
  const number = document.getElementById("number");
  const special = document.getElementById("special");
  const length = document.getElementById("length");
  const matchMsg = document.getElementById("password-match-msg");

  function validarPassword() {
    const pwd = passwordInput.value;
    const hasLower = /[a-z]/.test(pwd);
    const hasUpper = /[A-Z]/.test(pwd);
    const hasNumber = /\d/.test(pwd);
    const hasSpecial = /[\^!@#$%&*]/.test(pwd);
    const hasLength = pwd.length >= 8;

    lowerUpper.classList.toggle("valid", hasLower && hasUpper);
    lowerUpper.classList.toggle("invalid", !(hasLower && hasUpper));

    number.classList.toggle("valid", hasNumber);
    number.classList.toggle("invalid", !hasNumber);

    special.classList.toggle("valid", hasSpecial);
    special.classList.toggle("invalid", !hasSpecial);

    length.classList.toggle("valid", hasLength);
    length.classList.toggle("invalid", !hasLength);
  }

  function validarCoincidencia() {
    if (passwordInput.value && passwordConfirm.value) {
      if (passwordInput.value === passwordConfirm.value) {
        matchMsg.textContent = "‚úî Las contrase√±as coinciden.";
        matchMsg.classList.remove("text-danger");
        matchMsg.classList.add("text-success");
      } else {
        matchMsg.textContent = "‚úñ Las contrase√±as no coinciden.";
        matchMsg.classList.remove("text-success");
        matchMsg.classList.add("text-danger");
      }
    } else {
      matchMsg.textContent = "";
    }
  }

  passwordInput?.addEventListener("input", () => {
    validarPassword();
    validarCoincidencia();
  });

  passwordConfirm?.addEventListener("input", validarCoincidencia);
</script>
{% endblock %}
