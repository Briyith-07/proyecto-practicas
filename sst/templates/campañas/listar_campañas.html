{% extends 'base.html' %}

{% block content %}
<h2 class="text-center mb-4">游닉 Campa침as</h2>

<!-- Filtros en una sola l칤nea con botones juntos -->
<form method="get" class="row g-2 mb-4 align-items-end">
    <div class="col-md-2">
        <label for="estado" class="form-label">Estado</label>
        <select name="estado" id="estado" class="form-select">
            <option value="">Todos</option>
            <option value="activa" {% if request.GET.estado == 'activa' %}selected{% endif %}>Activa</option>
            <option value="pausada" {% if request.GET.estado == 'pausada' %}selected{% endif %}>Pausada</option>
            <option value="por_aprobacion" {% if request.GET.estado == 'por_aprobacion' %}selected{% endif %}>Por aprobaci칩n</option>
            <option value="finalizada" {% if request.GET.estado == 'finalizada' %}selected{% endif %}>Finalizada</option>
            <option value="rechazada" {% if request.GET.estado == 'rechazada' %}selected{% endif %}>Rechazada</option>
            <option value="aprobada" {% if request.GET.estado == 'aprobada' %}selected{% endif %}>Aprobada</option>
        </select>
    </div>
    <div class="col-md-2">
        <label for="periodicidad" class="form-label">Periodicidad</label>
        <select name="periodicidad" id="periodicidad" class="form-select">
            <option value="">Todas</option>
            <option value="diaria" {% if request.GET.periodicidad == 'diaria' %}selected{% endif %}>Diaria</option>
            <option value="semanal" {% if request.GET.periodicidad == 'semanal' %}selected{% endif %}>Semanal</option>
            <option value="mensual" {% if request.GET.periodicidad == 'mensual' %}selected{% endif %}>Mensual</option>
        </select>
    </div>
    <div class="col-md-2">
        <label for="fecha_desde" class="form-label">Desde</label>
        <input type="date" name="fecha_desde" id="fecha_desde" class="form-control" value="{{ request.GET.fecha_desde }}">
    </div>
    <div class="col-md-2">
        <label for="fecha_hasta" class="form-label">Hasta</label>
        <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control" value="{{ request.GET.fecha_hasta }}">
    </div>
    <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary mt-4">Filtrar</button>
        <a href="{% url 'listar_campa침as' %}" class="btn btn-secondary mt-4">Limpiar</a>
    </div>
</form>

<!-- Botones de acciones -->
<div class="d-flex flex-wrap gap-2 mb-4">
  <a href="{% url 'crear_campa침a' %}" class="btn btn-primary">Crear Campa침a</a>
  <a href="{% url 'listar_codigos' %}" class="btn btn-outline-info">C칩digos</a>

  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      Exportar
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{% url 'exportar_campa침as_pdf' %}" target="_blank">Exportar a PDF</a></li>
      <li><a class="dropdown-item" href="{% url 'exportar_campa침as_excel' %}">Exportar a Excel</a></li>
    </ul>
  </div>
</div>

<!-- Tabla de campa침as con bordes -->
<table class="table table-bordered table-striped align-middle text-center">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>C칩digo</th>
      <th>Nombre</th>
      <th>Detalle</th>
      <th>Estado</th>
      <th>Periodicidad</th>
      <th>Multimedia</th>
      <th>Asignaci칩n</th>
      <th>Creaci칩n</th>
      <th>Vencimiento</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for campa침a in campa침as %}
    <tr>
      <td>{{ campa침a.id }}</td>
      <td>{{ campa침a.codigo.codigo }}</td>
      <td>{{ campa침a.codigo.nombre }}</td>
      <td>{{ campa침a.detalle }}</td>
      <td>{{ campa침a.estado }}</td>
      <td>{{ campa침a.periodicidad }}</td>

      <!-- Multimedia -->
      <td>
        {% if campa침a.multimedia %}
          <a href="{{ campa침a.multimedia.url }}" target="_blank" class="text-primary me-2" title="Ver archivo">
            <i class="bi bi-eye-fill fs-5"></i>
          </a>
          <a href="{{ campa침a.multimedia.url }}" download class="text-success" title="Descargar archivo">
            <i class="bi bi-download fs-5"></i>
          </a>
        {% else %}
          <span class="text-muted">No disponible</span>
        {% endif %}
      </td>

      <!-- Asignaci칩n -->
      <td>
        {% if campa침a.grupos.all %}
            {% with grupo=campa침a.grupos.all.0 %}
                游논 {{ grupo.nombre }}
            {% endwith %}
        {% elif campa침a.campanaasignada_set.all %}
            {% with asignacion=campa침a.campanaasignada_set.all.0 %}
                游녻 {{ asignacion.empleado.first_name }} {{ asignacion.empleado.last_name }}
            {% endwith %}
        {% else %}
            <span class="text-muted">No asignado</span>
        {% endif %}
      </td>

      <!-- Fecha de creaci칩n -->
      <td>{{ campa침a.fecha_creacion|date:"Y-m-d H:i" }}</td>

      <!-- Fecha de vencimiento -->
      <td>
        {% if campa침a.campanaasignada_set.all %}
            {% with asignacion=campa침a.campanaasignada_set.all.0 %}
                {{ asignacion.fecha_vencimiento|date:"Y-m-d H:i" }}
            {% endwith %}
        {% else %}
            <span class="text-muted">No definido</span>
        {% endif %}
      </td>

      <!-- Acciones -->
      <td>
        <div class="d-flex justify-content-center gap-2">
          <a href="{% url 'editar_campa침a' campa침a.id %}" class="btn btn-warning btn-sm">Editar</a>
          <a href="{% url 'eliminar_campa침a' campa침a.id %}" class="btn btn-danger btn-sm">Eliminar</a>
        </div>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="11" class="text-center">No hay campa침as creadas.</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="text-center mt-4">
  <a href="/panel/dashboard/" class="btn btn-secondary">Volver</a>
</div>

{% endblock %}
