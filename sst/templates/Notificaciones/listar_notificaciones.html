{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">

    <!-- Título centrado -->
    <h2 class="mb-4 text-center fw-bold">Listado de Notificaciones</h2>

    <!-- Botones Crear y Volver -->
    <div class="d-flex justify-content-between mb-3">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle"></i> Volver
        </a>
        <a href="{% url 'crear_notificacion' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Crear Notificación
        </a>
    </div>

    <!-- =======================
         FILTROS Y BOTONES
    ======================== -->
    <form method="get" class="row g-3 mb-4 align-items-end">

        <!-- FILTRO TITULO -->
        <div class="col-md-3">
            <label class="form-label">Título</label>
            <select name="titulo" class="form-select">
                <option value="">Todos</option>
                {% for t in titulos %}
                    <option value="{{ t }}" {% if titulo_filtro == t %}selected{% endif %}>
                        {{ t|cut:"Nuevo mensaje: " }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- FILTRO USUARIO -->
        <div class="col-md-3">
            <label class="form-label">Usuario</label>
            <select name="usuario" class="form-select">
                <option value="">Todos</option>
                {% for u in usuarios %}
                    <option value="{{ u.id }}" {% if usuario_filtro == u.id|stringformat:'s' %}selected{% endif %}>
                        {{ u.first_name }} {{ u.last_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- FILTRO ABIERTA -->
        <div class="col-md-3">
            <label class="form-label">Abierta</label>
            <select name="abierta" class="form-select">
                <option value="" {% if abierta_filtro == "" %}selected{% endif %}>Todos</option>
                <option value="1" {% if abierta_filtro == "1" %}selected{% endif %}>Sí</option>
                <option value="0" {% if abierta_filtro == "0" %}selected{% endif %}>No</option>
            </select>
        </div>

        <!-- BOTONES FILTRAR Y LIMPIAR -->
        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-primary flex-fill">
                <i class="bi bi-filter"></i> Filtrar
            </button>
            <a href="{% url 'listar_notificaciones' %}" class="btn btn-secondary flex-fill">
                Limpiar
            </a>
        </div>

    </form>

    <!-- =======================
         TABLA
    ======================== -->
    <table class="table table-striped table-bordered text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>Título</th>
                <th>Usuario</th>
                <th>Cédula</th>
                <th>Código</th>
                <th>Tipo</th>
                <th>Enviada</th>
                <th>Abierta</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for n in notificaciones %}
            <tr>
                <td>{{ n.titulo|cut:"Nuevo mensaje: " }}</td>
                <td>{{ n.usuario.first_name }} {{ n.usuario.last_name }}</td>
                <td>{{ n.usuario.cedula }}</td>
                <td>{{ n.campaña.codigo }}</td>
                <td>Web y Correo</td>
                <td>
                    {% if n.enviada %}
                        <span class="text-success fw-bold">Sí</span>
                    {% else %}
                        <span class="text-danger fw-bold">No</span>
                    {% endif %}
                </td>
                <td>
                    {% if n.abierta %}
                        <span class="text-success fw-bold">Sí</span>
                    {% else %}
                        <span class="text-danger fw-bold">No</span>
                    {% endif %}
                </td>
                <td>
                    <div class="d-flex justify-content-center gap-1">
                        <a href="{% url 'detalle_notificacion_admin' n.id %}" class="btn btn-info btn-sm">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="{% url 'editar_notificacion' n.id %}" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <form action="{% url 'eliminar_notificacion' n.id %}" method="post" style="display:inline;" class="eliminar-form">
                            {% csrf_token %}
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center">No hay notificaciones</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- =======================
         PAGINACIÓN CON NÚMEROS
    ======================== -->
    <nav>
        <ul class="pagination justify-content-center">
            {% if notificaciones.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ notificaciones.previous_page_number }}&titulo={{ titulo_filtro }}&usuario={{ usuario_filtro }}&abierta={{ abierta_filtro }}">
                   «
                </a>
            </li>
            {% endif %}

            {% for num in notificaciones.paginator.page_range %}
            <li class="page-item {% if num == notificaciones.number %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ num }}&titulo={{ titulo_filtro }}&usuario={{ usuario_filtro }}&abierta={{ abierta_filtro }}">
                   {{ num }}
                </a>
            </li>
            {% endfor %}

            {% if notificaciones.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ notificaciones.next_page_number }}&titulo={{ titulo_filtro }}&usuario={{ usuario_filtro }}&abierta={{ abierta_filtro }}">
                   »
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

</div>

<!-- =======================
     SWEETALERT2 ELIMINAR
======================== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.querySelectorAll('.btn-eliminar').forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('.eliminar-form');
            Swal.fire({
                title: '¿Eliminar notificación?',
                text: "Esta acción no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
</script>
{% endblock %}
