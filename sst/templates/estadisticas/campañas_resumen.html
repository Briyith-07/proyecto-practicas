{% extends 'base.html' %}
{% block title %}Campa√±as{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4 fw-bold text-primary">üìã Campa√±as</h2>

  <!-- Tabla de Campa√±as -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white text-center">
      Campa√±as Creadas
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="tablaCampa√±as" class="table table-bordered table-hover align-middle text-center m-0">
          <thead class="table-light">
            <tr class="text-center">
              <th>ID</th>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Multimedia</th>
              <th>Evidencia</th>
              <th>Estado</th>
              <th>Periodicidad</th>
              <th>Asignado a</th>
              <th>Fecha de Creaci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for campa√±a in campa√±as %}
            <tr class="text-center">
              <td>{{ campa√±a.id }}</td>
              <td>{{ campa√±a.codigo.codigo }}</td>
              <td>{{ campa√±a.codigo.nombre }}</td>

              <td>
                {% if campa√±a.multimedia %}
                  <a href="{{ campa√±a.multimedia.url }}" target="_blank">Ver recurso</a>
                {% else %}
                  <span class="text-muted">No aplica</span>
                {% endif %}
              </td>

              <td>
                {% if campa√±a.evidencia_requerida %}
                  <span class="badge bg-info">S√≠</span>
                {% else %}
                  <span class="badge bg-light text-dark">No</span>
                {% endif %}
              </td>

              <!-- Estado -->
              <td>
                {% if campa√±a.estado == 'activa' %}
                  <span class="badge bg-success">Activa</span>
                {% elif campa√±a.estado == 'pausada' %}
                  <span class="badge bg-warning text-dark">Pausada</span>
                {% elif campa√±a.estado == 'por_aprobacion' %}
                  <span class="badge bg-info text-dark">Por aprobaci√≥n</span>
                {% elif campa√±a.estado == 'finalizada' %}
                  <span class="badge bg-secondary">Finalizada</span>
                {% elif campa√±a.estado == 'rechazada' %}
                  <span class="badge bg-danger">Rechazada</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ campa√±a.estado }}</span>
                {% endif %}
              </td>

              <td>{{ campa√±a.periodicidad }}</td>

              <!-- Nueva columna de asignaci√≥n √∫nica -->
              <td>
                {% if campa√±a.grupos.all.count > 0 %}
                    <!-- Si tiene grupo, mostrar solo el nombre -->
                    {{ campa√±a.grupos.all.first.nombre }}

                {% else %}
                    {% with empleados=campa√±a.campanaasignada_set.all %}
                        {% if empleados.count == 0 %}
                            <span class="text-muted">Sin asignaci√≥n</span>

                        {% elif empleados.count == 1 %}
                            {{ empleados.first.empleado.first_name }} {{ empleados.first.empleado.last_name }}

                        {% else %}
                            M√∫ltiples empleados
                        {% endif %}
                    {% endwith %}

                {% endif %}
              </td>

              <td>{{ campa√±a.fecha_creacion|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
              <tr><td colspan="9" class="text-center text-muted">No hay campa√±as.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Gr√°fico -->
  <div class="d-flex justify-content-end mb-2">
    <select id="filtroGrafica" class="form-select w-auto">
      <option value="periodicidad">üìÖ Periocidad</option>
      <option value="nombre">üè∑Ô∏è Nombre de campa√±a</option>
      <option value="estado">‚ö° Estado</option>
    </select>
  </div>

  <div class="card mt-4 shadow-sm p-4">
    <h5 class="mb-3 text-center">üìä Resumen de campa√±as Creadas</h5>
    <canvas id="graficoAsignaciones" height="100"></canvas>
  </div>

  <div class="text-center mt-4">
    <a href="/estadisticas/campa√±as/" class="btn btn-secondary">‚¨ÖÔ∏è Volver</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function normalizarEstado(estado) {
    return estado.toLowerCase().replace("√≥", "o").replace(" ", "_").trim();
  }

  function obtenerDatosDesdeTabla() {
    const filas = document.querySelectorAll("#tablaCampa√±as tbody tr");
    const datos = [];

    filas.forEach(fila => {
      const celdas = fila.children;

      datos.push({
        nombre: celdas[2].innerText.trim(),
        estado: normalizarEstado(celdas[5].innerText.trim()),
        periodicidad: celdas[6].innerText.trim()
      });
    });

    return datos;
  }

  const datosOriginales = obtenerDatosDesdeTabla();

  function agruparPor(campo) {
    const conteo = {};

    datosOriginales.forEach(item => {
      const key = item[campo] || "Sin dato";
      conteo[key] = (conteo[key] || 0) + 1;
    });

    return {
      labels: Object.keys(conteo),
      datos: Object.values(conteo)
    };
  }

  let agrupado = agruparPor("periodicidad");

  const ctx = document.getElementById('graficoAsignaciones');
  let grafico = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: agrupado.labels,
      datasets: [{
        label: 'Cantidad',
        data: agrupado.datos,
        backgroundColor: '#4FC3F7',
        borderColor: '#0288D1',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Gr√°fica por Periocidad' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  document.getElementById("filtroGrafica").addEventListener("change", function () {
    const campo = this.value;

    const nombres = {
      periodicidad: "Periocidad",
      nombre: "Nombre de campa√±a",
      estado: "Estado"
    };

    const nuevo = agruparPor(campo);

    grafico.data.labels = nuevo.labels;
    grafico.data.datasets[0].data = nuevo.datos;
    grafico.options.plugins.title.text = "Gr√°fica por " + nombres[campo];

    grafico.update();
  });
</script>

{% endblock %}
